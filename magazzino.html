<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ricerca Magazzino - I LOVE SHOPPING</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --brand-orange: #FD991F; --brand-gray: #7A8686; }
        body { font-family: 'Inter', sans-serif; }
        
        .loader {
            width: 48px; height: 48px;
            border: 5px solid #FFF; border-bottom-color: var(--brand-orange);
            border-radius: 50%; display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        
        .skugls { width: 150px; overflow-wrap: break-word; word-break: break-all; }
        
        .sku-button {
            font-weight: 500; color: var(--brand-orange); text-decoration: none;
            background: none; border: none; padding: 0; cursor: pointer;
            transition: all 0.2s ease; text-align: left; width: 100%;
        }
        .sku-button:hover { text-decoration: underline; color: #E48A1A; }

        .editable-cell { cursor: pointer; border: 1px solid transparent; border-radius: 4px; transition: all 0.2s; }
        .editable-cell:hover { background-color: #FFF7ED; border: 1px dashed var(--brand-orange); }

        .gemini-button {
            background-color: var(--brand-orange); color: white; font-weight: 600;
            padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer;
            transition: background-color 0.2s ease; display: inline-flex; align-items: center; gap: 8px;
        }
        .gemini-button:hover { background-color: #E48A1A; }
        .gemini-button:disabled { background-color: #fcae4a; cursor: not-allowed; }

        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    
    <script>
        tailwind.config = { theme: { extend: { colors: { 'brand-orange': 'var(--brand-orange)', 'brand-gray': 'var(--brand-gray)', } } } }
    </script>
</head>
<body class="bg-gray-100 text-brand-gray min-h-screen antialiased">

    <div class="container mx-auto max-w-7xl p-4 md:p-8">
        <nav class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
            <a href="https://delnic85.github.io/ILS/index.html" class="text-lg font-semibold text-brand-gray hover:text-brand-orange transition-all flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 16h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                </svg>
                Scannerizza etichetta
            </a>
            <div class="flex gap-6">
                <button id="nav-inventory" onclick="switchTab('inventory')" class="text-lg font-semibold text-brand-orange border-b-2 border-brand-orange pb-1 transition-all">Ricerca Magazzino</button>
                <button id="nav-bestsellers" onclick="switchTab('bestsellers')" class="text-lg font-semibold text-brand-gray hover:text-brand-orange transition-all">BEST SELLERS</button>
            </div>
        </nav>
        
        <div id="inventory-view">
            <header class="flex items-center justify-center gap-4 mb-8">
                <h1 class="text-3xl md:text-5xl font-bold text-brand-orange tracking-tight">I LOVE SHOPPING</h1>
            </header> 
            <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 mb-8">
                <div class="mb-8">
                    <label for="search-box" class="sr-only">Cerca</label>
                    <input type="text" id="search-box" placeholder="Cerca per SKU, nome, categoria, brand..." class="w-full p-4 border border-gray-300 rounded-lg text-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-brand-orange focus:border-transparent">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Categoria</label><select id="filter-category" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white focus:outline-none focus:ring-2 focus:ring-brand-orange"><option value="">Tutte le categorie</option></select></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Brand</label><select id="filter-brand" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white focus:outline-none focus:ring-2 focus:ring-brand-orange"><option value="">Tutti i brand</option></select></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Scaffale</label><select id="filter-shelf" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white focus:outline-none focus:ring-2 focus:ring-brand-orange"><option value="">Tutti gli scaffali</option></select></div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div id="status-message" class="p-8 text-center">
                <div class="flex flex-col items-center justify-center space-y-4">
                    <span class="loader"></span>
                    <span class="text-gray-500 font-medium">Caricamento dati dal magazzino...</span>
                </div>
            </div>

            <div id="inventory-container-wrapper">
                <div id="results-container" class="overflow-x-auto hidden md:block">
                    <table class="w-full min-w-max">
                        <thead class="bg-brand-gray text-white sticky top-0">
                            <tr>
                                <th class="p-4 text-left text-sm font-semibold uppercase">Immagine</th>
                                <th class="p-4 skugls text-left text-sm font-semibold uppercase">SKU GLS</th>
                                <th class="p-4 text-left text-sm font-semibold uppercase">Categoria</th>
                                <th class="p-4 text-left text-sm font-semibold uppercase">Brand</th>
                                <th class="p-4 text-left text-sm font-semibold uppercase">QTY Mag</th>
                                <th class="p-4 text-left text-sm font-semibold uppercase">Scaffale</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div id="results-cards-container" class="block md:hidden"></div>
            </div>

            <div id="bestsellers-container-wrapper" class="hidden">
                <div id="bestsellers-table-container" class="overflow-x-auto hidden md:block">
                    <table class="w-full min-w-max">
                        <thead class="bg-brand-gray text-white sticky top-0">
                            <tr>
                                <th class="p-4 text-left text-sm font-semibold uppercase">Immagine</th>
                                <th class="p-4 skugls text-left text-sm font-semibold uppercase">SKU GLS</th>
                                <th id="th-24h" onclick="sortBestSellers('qty24')" class="p-4 text-left text-sm font-semibold uppercase cursor-pointer hover:bg-opacity-80">24 H <span id="sort-arrow-24h"></span></th>
                                <th id="th-7g" onclick="sortBestSellers('qty7')" class="p-4 text-left text-sm font-semibold uppercase cursor-pointer hover:bg-opacity-80">7 GG <span id="sort-arrow-7g"></span></th>
                                <th id="th-30g" onclick="sortBestSellers('qty30')" class="p-4 text-left text-sm font-semibold uppercase cursor-pointer hover:bg-opacity-80">30 GG <span id="sort-arrow-30g"></span></th>
                                <th id="th-365g" onclick="sortBestSellers('qty365')" class="p-4 text-left text-sm font-semibold uppercase cursor-pointer hover:bg-opacity-80">365 GG <span id="sort-arrow-365g"></span></th>
                            </tr>
                        </thead>
                        <tbody id="bestsellers-table-body" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div id="bestsellers-cards-container" class="block md:hidden"></div>
            </div>
        </div>

        <div id="bestsellers-header" class="hidden mt-8">
            <header class="flex items-center justify-center gap-4 mb-8">
                <h1 class="text-3xl md:text-5xl font-bold text-brand-orange tracking-tight">Best Sellers</h1>
            </header>
        </div>
    </div>

    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-40">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 relative">
            <button onclick="closeProductModal()" class="absolute top-4 right-4 text-3xl text-brand-gray hover:text-black">&times;</button>
            <h2 class="text-2xl font-bold text-brand-orange mb-4">Dettagli Prodotto</h2>
            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex-shrink-0"><img id="modal-img" src="" class="w-[150px] h-[150px] object-contain rounded-lg bg-white"></div>
                <div class="flex-grow">
                    <h3 id="modal-sku" class="text-xl font-semibold text-gray-900"></h3>
                    <p id="modal-details" class="text-md text-brand-gray mt-1"></p>
                    <p id="modal-stock" class="text-md text-brand-gray mt-1"></p>
                </div>
            </div>
            <div class="mt-6 border-t border-gray-200 pt-6">
                <button id="gemini-generate-btn" class="gemini-button">✨ Genera Descrizione Prodotto</button>
                <div id="gemini-result-container" class="mt-4 bg-gray-50 p-4 rounded-lg min-h-[60px] text-gray-700 text-sm"></div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 relative">
            <h2 class="text-2xl font-bold text-brand-orange mb-4">Modifica Dati</h2>
            <p id="edit-modal-info" class="text-gray-600 mb-4 text-sm"></p>
            <div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2">Nuovo Valore</label><input type="text" id="edit-input" class="w-full p-4 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-brand-orange"></div>
            <div class="flex justify-end gap-3">
                <button onclick="closeEditModal()" class="px-4 py-2 text-gray-600 font-semibold hover:bg-gray-100 rounded-lg">Annulla</button>
                <button onclick="saveEdit()" id="save-btn" class="px-6 py-2 bg-brand-orange text-white font-bold rounded-lg hover:bg-opacity-90 flex items-center gap-2"><span id="save-btn-text">Salva Modifiche</span><span id="save-loader" class="loader hidden" style="width:20px;height:20px;border-width:2px;"></span></button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURAZIONE
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQLf2HBC2g4q3L-hER7WPpYixWIIqJyV6MAkWm4ENZlQNrLxbroZRP3HBZ7Uzl510OVON8q590_YH_S/pub?gid=938359466&single=true&output=csv';
        const LOG_VENDITE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQLf2HBC2g4q3L-hER7WPpYixWIIqJyV6MAkWm4ENZlQNrLxbroZRP3HBZ7Uzl510OVON8q590_YH_S/pub?gid=135483104&single=true&output=csv';
        const APPS_SCRIPT_URL = 'INSERISCI_QUI_URL_APPS_SCRIPT'; // <--- RIMETTI IL TUO URL QUI
        const apiKey = ""; 

        // GLOBALI
        let allProducts = [];
        let salesLog24h = new Map();
        let sortState = { column: 'qty24', direction: 'desc' };
        let currentEditingSku = null, currentEditingField = null;
        let isBestsellersRendered = false; // Flag per lazy loading

        // Mapping CSV
        const COLS = { A_ASIN: 0, B: 1, C_SKU: 2, E_CAT: 4, F_BRAND: 5, H_QTY: 7, I_SCAFFALE: 8, Q_7G: 16, R_30G: 17, S_365G: 18, AB_IMG: 27 };

        // DOM Elements
        const el = id => document.getElementById(id);
        
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            
            el('search-box').addEventListener('input', () => renderTable()); // Debounce opzionale qui
            el('filter-category').addEventListener('change', renderTable);
            el('filter-brand').addEventListener('change', renderTable);
            el('filter-shelf').addEventListener('change', renderTable);

            // Delegated events
            document.body.addEventListener('click', e => {
                const btn = e.target.closest('.sku-button');
                if (btn) openProductModal(btn.dataset.sku);
                
                const edit = e.target.closest('.editable-cell');
                if (edit && !currentEditingSku) { /* Gestito inline onclick per semplicità, ma meglio qui */ }
                
                if (e.target === el('product-modal')) closeProductModal();
                if (e.target === el('edit-modal')) closeEditModal();
            });
        });

        // --- FETCH OTTIMIZZATO ---
        async function fetchData() {
            try {
                const [invRes, logRes] = await Promise.all([fetch(CSV_URL), fetch(LOG_VENDITE_URL)]);
                if (!invRes.ok || !logRes.ok) throw new Error("Errore HTTP");
                
                const [invText, logText] = await Promise.all([invRes.text(), logRes.text()]);

                processLogVendite(logText);
                allProducts = parseCSVFast(invText);
                
                populateFilters();
                renderTable(); // Renderizza solo Inventario all'inizio
                
                el('status-message').classList.add('hidden');
                switchTab('inventory'); // Forza vista iniziale
            } catch (err) {
                console.error(err);
                el('status-message').innerHTML = `<span class="text-red-600">Errore caricamento. Ricarica la pagina.</span>`;
            }
        }

        // --- PARSER CSV VELOCE (REGEX) ---
        function parseCSVFast(text) {
            const rows = text.split(/\r?\n/);
            // Salta header
            if (rows.length > 0) rows.shift();
            
            // Regex ottimizzata per split CSV rispettando le virgolette
            // Nota: Questo è molto più veloce di un ciclo for char-by-char
            const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
            
            return rows.map(row => {
                if (!row.trim()) return null;
                // Split veloce
                const cols = row.split(regex).map(s => s.replace(/^"|"$/g, '').trim());
                
                const sku = cols[COLS.C_SKU];
                if (!sku) return null;

                const asin = cols[COLS.A_ASIN] || '';
                return {
                    sku: sku,
                    asin: asin,
                    immagine: cols[COLS.AB_IMG] || '',
                    categoria: cols[COLS.E_CAT] || '',
                    brand: cols[COLS.F_BRAND] || '',
                    qty: cols[COLS.H_QTY] || '0',
                    scaffale: cols[COLS.I_SCAFFALE] || '',
                    qty24: salesLog24h.get(asin) || 0,
                    qty7: parseInt(cols[COLS.Q_7G]) || 0,
                    qty30: parseInt(cols[COLS.R_30G]) || 0,
                    qty365: parseInt(cols[COLS.S_365G]) || 0,
                    searchData: (asin + " " + cols[COLS.B] + " " + sku + " " + cols[COLS.E_CAT] + " " + cols[COLS.F_BRAND]).toLowerCase()
                };
            }).filter(p => p !== null);
        }

        // --- PARSING DATE ROBUSTO ---
        function processLogVendite(text) {
            const rows = text.split(/\r?\n/);
            rows.shift();
            salesLog24h.clear();
            
            const now = new Date();
            const oneDayMs = 24 * 60 * 60 * 1000;
            const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;

            rows.forEach(row => {
                if (!row.trim()) return;
                const cols = row.split(regex).map(s => s.replace(/^"|"$/g, '').trim());
                if (cols.length < 3) return;

                const dateStr = cols[0]; // Data
                const asin = cols[1];    // ASIN
                const qty = parseInt(cols[2]) || 0;

                let entryDate;
                
                // Tenta parsing manuale DD/MM/YYYY o DD-MM-YYYY
                const parts = dateStr.split(/[\/\-\s:]/); // Split su / - spazio o :
                if (parts.length >= 3) {
                    // Assumiamo DD/MM/YYYY o YYYY-MM-DD
                    const p1 = parseInt(parts[0]);
                    const p2 = parseInt(parts[1]);
                    const p3 = parseInt(parts[2]);
                    
                    // Rilevamento euristico: Se p1 > 12 è sicuramente il giorno (o anno).
                    // Google sheet IT standard: GG/MM/AAAA HH:MM
                    if (p3 > 1000) {
                        // Formato GG/MM/AAAA
                        const h = parts[3] ? parseInt(parts[3]) : 0;
                        const m = parts[4] ? parseInt(parts[4]) : 0;
                        entryDate = new Date(p3, p2 - 1, p1, h, m);
                    } else if (p1 > 1000) {
                        // Formato AAAA-MM-GG
                        entryDate = new Date(p1, p2 - 1, p3);
                    }
                }

                // Fallback a Date.parse se manuale fallisce
                if (!entryDate || isNaN(entryDate.getTime())) {
                    entryDate = new Date(dateStr);
                }

                if (!isNaN(entryDate.getTime())) {
                    if (now - entryDate <= oneDayMs && now >= entryDate) {
                        const current = salesLog24h.get(asin) || 0;
                        salesLog24h.set(asin, current + qty);
                    }
                }
            });
        }

        // --- FILTRI ---
        function populateFilters() {
            const cats = new Set(), brands = new Set(), shelves = new Set();
            allProducts.forEach(p => {
                if(p.categoria) cats.add(p.categoria);
                if(p.brand) brands.add(p.brand);
                if(p.scaffale) shelves.add(p.scaffale);
            });
            const fill = (id, set) => {
                const sel = el(id);
                [...set].sort().forEach(v => { const o = document.createElement('option'); o.value = v; o.text = v; sel.add(o); });
            };
            fill('filter-category', cats); fill('filter-brand', brands); fill('filter-shelf', shelves);
        }

        // --- GESTIONE VISTE (LAZY LOADING) ---
        function switchTab(view) {
            const invView = el('inventory-view');
            const invWrap = el('inventory-container-wrapper');
            const bsHeader = el('bestsellers-header');
            const bsWrap = el('bestsellers-container-wrapper');
            const navInv = el('nav-inventory');
            const navBs = el('nav-bestsellers');

            if (view === 'inventory') {
                invView.classList.remove('hidden');
                invWrap.classList.remove('hidden');
                bsHeader.classList.add('hidden');
                bsWrap.classList.add('hidden');
                
                navInv.className = "text-lg font-semibold text-brand-orange border-b-2 border-brand-orange pb-1 transition-all";
                navBs.className = "text-lg font-semibold text-brand-gray hover:text-brand-orange transition-all";
            } else {
                invView.classList.add('hidden');
                invWrap.classList.add('hidden');
                bsHeader.classList.remove('hidden');
                bsWrap.classList.remove('hidden');
                
                navInv.className = "text-lg font-semibold text-brand-gray hover:text-brand-orange transition-all";
                navBs.className = "text-lg font-semibold text-brand-orange border-b-2 border-brand-orange pb-1 transition-all";
                
                // Lazy render: Genera la tabella solo al primo click
                if (!isBestsellersRendered) {
                    renderBestSellers();
                    isBestsellersRendered = true;
                }
            }
        }

        // --- RENDER INVENTARIO ---
        function renderTable() {
            const term = el('search-box').value.toLowerCase().trim();
            const keys = term.split(' ').filter(k => k);
            const cat = el('filter-category').value, br = el('filter-brand').value, sh = el('filter-shelf').value;

            // Filtro veloce
            const filtered = allProducts.filter(p => {
                if (cat && p.categoria !== cat) return false;
                if (br && p.brand !== br) return false;
                if (sh && p.scaffale !== sh) return false;
                if (keys.length > 0) {
                    return keys.every(k => p.searchData.includes(k));
                }
                return true;
            });

            const tb = el('results-table-body');
            const cards = el('results-cards-container');
            const cont = el('results-container');
            const msg = el('status-message');

            tb.innerHTML = ''; cards.innerHTML = '';

            if (filtered.length === 0) {
                cont.classList.add('hidden'); cards.classList.add('hidden');
                msg.innerHTML = '<div class="p-8 text-center text-gray-500">Nessun prodotto trovato.</div>';
                msg.classList.remove('hidden');
                return;
            }

            msg.classList.add('hidden');
            cont.classList.remove('hidden'); cards.classList.remove('hidden');

            const isSingle = filtered.length === 1;
            
            // Limitiamo il render a 100 elementi per performance se non c'è ricerca specifica
            const toRender = filtered.slice(0, 100); 

            let rows = '', cardsHtml = '';
            
            toRender.forEach(p => {
                const img = p.immagine || `https://placehold.co/150x150/FD991F/white?text=${p.sku[0]}`;
                const imgMob = p.immagine || `https://placehold.co/300x300/FD991F/white?text=${p.sku[0]}`;

                rows += `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="p-3"><img src="${img}" class="w-[150px] h-[150px] object-contain rounded-md bg-white" loading="lazy" onerror="this.src='https://placehold.co/150x150/FD991F/white?text=?'"></td>
                        <td class="p-3 skugls"><button class="sku-button" data-sku="${p.sku}">${p.sku}</button></td>
                        <td class="p-3 text-sm text-gray-700">${p.categoria}</td>
                        <td class="p-3 text-2xl font-bold text-gray-900">${p.brand}</td>
                        <td class="p-3 text-3xl font-bold text-center editable-cell" onclick="openEditModal('${p.sku}', 'qty', '${p.qty}')">${p.qty}</td>
                        <td class="p-3 text-5xl font-bold text-brand-orange leading-tight break-words max-w-[300px] editable-cell" onclick="openEditModal('${p.sku}', 'scaffale', '${p.scaffale}')">${p.scaffale}</td>
                    </tr>`;

                if (isSingle) {
                    cardsHtml += `
                        <div class="p-6 flex flex-col items-center text-center space-y-6">
                            <div class="w-full bg-white rounded-xl p-4 border border-gray-100"><img src="${imgMob}" class="w-full max-w-[300px] mx-auto object-contain" onerror="this.src='https://placehold.co/300x300/FD991F/white?text=?'"></div>
                            <div class="w-full"><button class="sku-button w-full text-center" data-sku="${p.sku}"><h2 class="text-3xl font-bold text-brand-orange break-all">${p.sku}</h2></button>
                            <p class="text-xl font-medium text-gray-900 mt-2">${p.brand}</p>
                            <div class="mt-6 grid grid-cols-2 gap-4 bg-gray-50 rounded-xl p-4 border border-gray-200">
                                <div class="flex flex-col editable-cell p-2" onclick="openEditModal('${p.sku}', 'qty', '${p.qty}')"><span class="text-sm text-gray-500 font-semibold">Quantità ✏️</span><span class="text-3xl font-bold text-gray-900">${p.qty}</span></div>
                                <div class="flex flex-col editable-cell p-2" onclick="openEditModal('${p.sku}', 'scaffale', '${p.scaffale}')"><span class="text-sm text-gray-500 font-semibold">Scaffale ✏️</span><span class="text-5xl font-bold text-brand-orange break-words leading-tight">${p.scaffale}</span></div>
                            </div></div>
                        </div>`;
                } else {
                    cardsHtml += `
                        <div class="flex p-4 border-b border-gray-200 last:border-b-0">
                            <div class="flex-shrink-0 w-[120px] h-[120px] bg-white rounded-md border border-gray-100 p-1 flex items-center justify-center"><img src="${img}" class="w-full h-full object-contain" loading="lazy" onerror="this.src='https://placehold.co/150x150/FD991F/white?text=?'"></div>
                            <div class="ml-4 flex-grow min-w-0">
                                <button class="sku-button" data-sku="${p.sku}"><h3 class="text-lg font-bold text-brand-orange truncate">${p.sku}</h3></button>
                                <p class="text-sm font-medium text-gray-900 truncate">${p.brand}</p>
                                <p class="text-base font-semibold text-gray-800 mt-1 w-max editable-cell" onclick="openEditModal('${p.sku}', 'qty', '${p.qty}')">QTY: ${p.qty} ✏️</p>
                                <p class="text-2xl font-bold text-gray-700 mt-1 w-max editable-cell" onclick="openEditModal('${p.sku}', 'scaffale', '${p.scaffale}')">Scaff: ${p.scaffale} ✏️</p>
                            </div>
                        </div>`;
                }
            });
            
            tb.innerHTML = rows;
            cards.innerHTML = cardsHtml;
        }

        // --- RENDER BEST SELLERS ---
        function sortBestSellers(col) {
            if (sortState.column === col) sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            else { sortState.column = col; sortState.direction = 'desc'; }
            renderBestSellers();
        }

        function renderBestSellers() {
            const data = allProducts.filter(p => p.qty24 > 0 || p.qty7 > 0 || p.qty30 > 0 || p.qty365 > 0);
            
            data.sort((a, b) => sortState.direction === 'asc' ? a[sortState.column] - b[sortState.column] : b[sortState.column] - a[sortState.column]);
            
            ['24h', '7g', '30g', '365g'].forEach(k => { const e = el('sort-arrow-'+k); if(e) e.textContent = ''; });
            const arr = sortState.direction === 'asc' ? ' ↑' : ' ↓';
            const map = { qty24: '24h', qty7: '7g', qty30: '30g', qty365: '365g' };
            if(el('sort-arrow-'+map[sortState.column])) el('sort-arrow-'+map[sortState.column]).textContent = arr;

            const tb = el('bestsellers-table-body');
            const cards = el('bestsellers-cards-container');
            
            if (data.length === 0) {
                tb.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-500">Nessun dato.</td></tr>';
                cards.innerHTML = '<div class="p-8 text-center text-gray-500">Nessun dato.</div>';
                return;
            }

            let rows = '', cardsHtml = '';
            data.slice(0, 100).forEach(p => { // Limitiamo a 100 per performance
                const img = p.immagine || `https://placehold.co/150x150/FD991F/white?text=${p.sku[0]}`;
                rows += `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="p-3"><img src="${img}" class="w-[150px] h-[150px] object-contain rounded-md bg-white" loading="lazy" onerror="this.src='https://placehold.co/150x150/FD991F/white?text=?'"></td>
                        <td class="p-3 skugls"><button class="sku-button" data-sku="${p.sku}">${p.sku}</button></td>
                        <td class="p-3 text-lg font-bold text-center text-red-600">${p.qty24}</td>
                        <td class="p-3 text-lg font-semibold text-center">${p.qty7}</td>
                        <td class="p-3 text-lg font-semibold text-center">${p.qty30}</td>
                        <td class="p-3 text-lg font-semibold text-center">${p.qty365}</td>
                    </tr>`;
                
                cardsHtml += `
                    <div class="flex flex-col p-4 border-b border-gray-200 last:border-b-0">
                        <div class="flex items-center mb-4">
                            <div class="flex-shrink-0 w-[100px] h-[100px] bg-white rounded-md border border-gray-100 flex items-center justify-center p-1"><img src="${img}" class="w-full h-full object-contain" loading="lazy" onerror="this.src='https://placehold.co/150x150/FD991F/white?text=?'"></div>
                            <div class="ml-4 flex-grow min-w-0"><button class="sku-button" data-sku="${p.sku}"><h3 class="text-lg font-bold text-brand-orange truncate">${p.sku}</h3></button><p class="text-sm font-medium text-gray-900 truncate">${p.brand}</p></div>
                        </div>
                        <div class="grid grid-cols-4 gap-2 text-center bg-gray-50 p-2 rounded-lg">
                            <div><div class="text-xs text-gray-500">24H</div><div class="text-lg font-bold text-red-600">${p.qty24}</div></div>
                            <div><div class="text-xs text-gray-500">7G</div><div class="text-lg font-semibold">${p.qty7}</div></div>
                            <div><div class="text-xs text-gray-500">30G</div><div class="text-lg font-semibold">${p.qty30}</div></div>
                            <div><div class="text-xs text-gray-500">365G</div><div class="text-lg font-semibold">${p.qty365}</div></div>
                        </div>
                    </div>`;
            });
            tb.innerHTML = rows; cards.innerHTML = cardsHtml;
        }

        // --- GESTIONE MODALI EDIT & PRODOTTO ---
        function openProductModal(sku) {
            const p = allProducts.find(x => x.sku === sku); if(!p) return;
            el('modal-img').src = p.immagine || `https://placehold.co/150x150/FD991F/white?text=${p.sku[0]}`;
            el('modal-sku').textContent = p.sku;
            el('modal-details').textContent = `Brand: ${p.brand} | Cat: ${p.categoria}`;
            el('modal-stock').textContent = `Mag: ${p.qty} | Scaff: ${p.scaffale}`;
            el('gemini-result-container').innerHTML = ''; el('gemini-generate-btn').disabled = false;
            el('gemini-generate-btn').onclick = () => callGemini(p);
            el('product-modal').classList.remove('hidden');
        }
        function closeProductModal() { el('product-modal').classList.add('hidden'); }

        function openEditModal(sku, field, val) {
            currentEditingSku = sku; currentEditingField = field;
            el('edit-modal-info').textContent = `Modifica ${field === 'qty' ? 'Quantità' : 'Scaffale'} per ${sku}`;
            el('edit-input').value = val === 'undefined' ? '' : val;
            el('edit-modal').classList.remove('hidden'); el('edit-input').focus();
        }
        function closeEditModal() { el('edit-modal').classList.add('hidden'); }

        async function saveEdit() {
            if (APPS_SCRIPT_URL.includes('INSERISCI')) { alert("Errore: Configura lo script!"); return; }
            el('save-btn').disabled = true; el('save-loader').classList.remove('hidden');
            try {
                await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({sku: currentEditingSku, field: currentEditingField, value: el('edit-input').value}) });
                const p = allProducts.find(x => x.sku === currentEditingSku);
                if(p) p[currentEditingField] = el('edit-input').value;
                renderTable(); closeEditModal();
            } catch { alert("Errore salvataggio"); }
            finally { el('save-btn').disabled = false; el('save-loader').classList.add('hidden'); }
        }

        async function callGemini(p) {
            el('gemini-generate-btn').disabled = true; el('gemini-result-container').innerHTML = '<span class="loader" style="width:24px;height:24px;border-width:3px"></span>';
            const q = `Descrivi prodotto:\nBrand: ${p.brand}\nCat: ${p.categoria}\nSKU: ${p.sku}`;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: q }] }] }) });
                const json = await res.json();
                el('gemini-result-container').innerHTML = json.candidates?.[0]?.content?.parts?.[0]?.text || "Nessun testo.";
            } catch { el('gemini-result-container').innerHTML = "Errore API."; }
        }
    </script>
</body>
</html>
