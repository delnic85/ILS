<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ricerca Magazzino - I LOVE SHOPPING</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --brand-orange: #FD991F; 
            --brand-gray: #7A8686; 
        }
        
        body { font-family: 'Inter', sans-serif; }

        .loader {
            width: 48px; height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: var(--brand-orange);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .skugls { 
            width: 150px; 
            overflow-wrap: break-word; 
            word-break: break-all; 
        }
        
        .sku-button {
            font-weight: 500; color: var(--brand-orange);
            text-decoration: none; background: none; border: none; padding: 0;
            cursor: pointer; transition: all 0.2s ease;
            text-align: left; width: 100%;
        }
        .sku-button:hover { text-decoration: underline; color: #E48A1A; }

        /* Stile celle editabili */
        .editable-cell {
            cursor: pointer;
            border: 1px solid transparent;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .editable-cell:hover {
            background-color: #FFF7ED; /* Arancione chiarissimo */
            border: 1px dashed var(--brand-orange);
        }

        .gemini-button {
            background-color: var(--brand-orange); color: white;
            font-weight: 600; padding: 10px 16px; border-radius: 8px; border: none;
            cursor: pointer; transition: background-color 0.2s ease;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .gemini-button:hover { background-color: #E48A1A; }
        .gemini-button:disabled { background-color: #fcae4a; cursor: not-allowed; }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-orange': 'var(--brand-orange)',
                        'brand-gray': 'var(--brand-gray)',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 text-brand-gray min-h-screen antialiased">

    <div class="container mx-auto max-w-7xl p-4 md:p-8">

        <nav class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
            <a href="https://delnic85.github.io/ILS/index.html" 
               class="text-lg font-semibold text-brand-gray hover:text-brand-orange transition-all flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 16h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                </svg>
                Scannerizza etichetta
            </a>

            <div class="flex gap-6">
                <button id="nav-inventory" onclick="showView('inventory')" 
                        class="text-lg font-semibold text-brand-orange border-b-2 border-brand-orange pb-1 transition-all">
                    Ricerca Magazzino
                </button>
                <button id="nav-bestsellers" onclick="showView('bestsellers')" 
                        class="text-lg font-semibold text-brand-gray hover:text-brand-orange transition-all">
                    BEST SELLERS
                </button>
            </div>
        </nav>
        
        <div id="inventory-view">
            <header class="flex items-center justify-center gap-4 mb-8">
                    <h1 class="text-3xl md:text-5xl font-bold text-brand-orange tracking-tight">
                        I LOVE SHOPPING
                    </h1>
            </header> 

            <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 mb-8">
                <div class="mb-8">
                    <label for="search-box" class="sr-only">Cerca</label>
                    <input type="text" id="search-box" 
                            placeholder="Cerca per SKU, nome, categoria, brand..." 
                            class="w-full p-4 border border-gray-300 rounded-lg text-lg shadow-sm
                                     focus:outline-none focus:ring-2 focus:ring-brand-orange focus:border-transparent">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="filter-category" class="block text-sm font-medium text-gray-700 mb-2">Categoria</label>
                        <select id="filter-category" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white focus:outline-none focus:ring-2 focus:ring-brand-orange"><option value="">Tutte le categorie</option></select>
                    </div>
                    <div>
                        <label for="filter-brand" class="block text-sm font-medium text-gray-700 mb-2">Brand</label>
                        <select id="filter-brand" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white focus:outline-none focus:ring-2 focus:ring-brand-orange"><option value="">Tutti i brand</option></select>
                    </div>
                    <div>
                        <label for="filter-shelf" class="block text-sm font-medium text-gray-700 mb-2">Scaffale</label>
                        <select id="filter-shelf" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white focus:outline-none focus:ring-2 focus:ring-brand-orange"><option value="">Tutti gli scaffali</option></select>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div id="status-message" class="p-8 text-center">
                <div class="flex flex-col items-center justify-center space-y-4">
                    <span class="loader"></span>
                    <span class="text-gray-500 font-medium">Caricamento dati dal magazzino...</span>
                </div>
            </div>

            <div id="results-container" class="overflow-x-auto hidden md:block">
                <table class="w-full min-w-max">
                    <thead class="bg-brand-gray text-white sticky top-0">
                        <tr>
                            <th class="p-4 text-left text-sm font-semibold uppercase tracking-wider">Immagine</th>
                            <th class="p-4 skugls text-left text-sm font-semibold uppercase tracking-wider">SKU GLS</th>
                            <th class="p-4 text-left text-sm font-semibold uppercase tracking-wider">Categoria</th>
                            <th class="p-4 text-left text-sm font-semibold uppercase tracking-wider">Brand</th>
                            <th class="p-4 text-left text-sm font-semibold uppercase tracking-wider">QTY Mag</th>
                            <th class="p-4 text-left text-sm font-semibold uppercase tracking-wider">Scaffale</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>

            <div id="results-cards-container" class="block md:hidden"></div>
        </div>

        <div id="bestsellers-view" class="hidden">
            <header class="flex items-center justify-center gap-4 mb-8">
                <h1 class="text-3xl md:text-5xl font-bold text-brand-orange tracking-tight">Best Sellers</h1>
            </header>
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div id="bestsellers-table-container" class="overflow-x-auto hidden md:block">
                    <table class="w-full min-w-max">
                        <thead class="bg-brand-gray text-white sticky top-0">
                            <tr>
                                <th class="p-4 text-left text-sm font-semibold uppercase tracking-wider">Immagine</th>
                                <th class="p-4 skugls text-left text-sm font-semibold uppercase tracking-wider">SKU GLS</th>
                                <th id="th-24h" onclick="sortBestSellers('qty24')" class="p-4 text-left text-sm font-semibold uppercase tracking-wider cursor-pointer hover:bg-opacity-80">24 H <span id="sort-arrow-24h"></span></th>
                                <th id="th-7g" onclick="sortBestSellers('qty7')" class="p-4 text-left text-sm font-semibold uppercase tracking-wider cursor-pointer hover:bg-opacity-80">7 GG <span id="sort-arrow-7g"></span></th>
                                <th id="th-30g" onclick="sortBestSellers('qty30')" class="p-4 text-left text-sm font-semibold uppercase tracking-wider cursor-pointer hover:bg-opacity-80">30 GG <span id="sort-arrow-30g"></span></th>
                                <th id="th-365g" onclick="sortBestSellers('qty365')" class="p-4 text-left text-sm font-semibold uppercase tracking-wider cursor-pointer hover:bg-opacity-80">365 GG <span id="sort-arrow-365g"></span></th>
                            </tr>
                        </thead>
                        <tbody id="bestsellers-table-body" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div id="bestsellers-cards-container" class="block md:hidden"></div>
            </div>
        </div>
    </div>

    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-40">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 relative" id="modal-content">
            <button onclick="closeProductModal()" class="absolute top-4 right-4 text-3xl text-brand-gray hover:text-black">&times;</button>
            <h2 class="text-2xl font-bold text-brand-orange mb-4">Dettagli Prodotto</h2>
            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex-shrink-0">
                    <img id="modal-img" src="" alt="Immagine prodotto" class="w-[150px] h-[150px] object-contain rounded-lg bg-white">
                </div>
                <div class="flex-grow">
                    <h3 id="modal-sku" class="text-xl font-semibold text-gray-900"></h3>
                    <p id="modal-details" class="text-md text-brand-gray mt-1"></p>
                    <p id="modal-stock" class="text-md text-brand-gray mt-1"></p>
                </div>
            </div>
            <div class="mt-6 border-t border-gray-200 pt-6">
                <button id="gemini-generate-btn" class="gemini-button">✨ Genera Descrizione Prodotto</button>
                <div id="gemini-result-container" class="mt-4 bg-gray-50 p-4 rounded-lg min-h-[60px] text-gray-700 text-sm"></div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 relative">
            <h2 class="text-2xl font-bold text-brand-orange mb-4">Modifica Dati</h2>
            <p id="edit-modal-info" class="text-gray-600 mb-4 text-sm"></p>
            <div class="mb-6">
                <label for="edit-input" class="block text-sm font-medium text-gray-700 mb-2">Nuovo Valore</label>
                <input type="text" id="edit-input" class="w-full p-4 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-brand-orange focus:border-transparent">
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeEditModal()" class="px-4 py-2 text-gray-600 font-semibold hover:bg-gray-100 rounded-lg">Annulla</button>
                <button onclick="saveEdit()" id="save-btn" class="px-6 py-2 bg-brand-orange text-white font-bold rounded-lg hover:bg-opacity-90 flex items-center gap-2">
                    <span id="save-btn-text">Salva Modifiche</span>
                    <span id="save-loader" class="loader hidden" style="width: 20px; height: 20px; border-width: 2px;"></span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURAZIONE ---
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQLf2HBC2g4q3L-hER7WPpYixWIIqJyV6MAkWm4ENZlQNrLxbroZRP3HBZ7Uzl510OVON8q590_YH_S/pub?gid=938359466&single=true&output=csv';
        const LOG_VENDITE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQLf2HBC2g4q3L-hER7WPpYixWIIqJyV6MAkWm4ENZlQNrLxbroZRP3HBZ7Uzl510OVON8q590_YH_S/pub?gid=135483104&single=true&output=csv';
        
        // !!! URL APPS SCRIPT !!!
        const APPS_SCRIPT_URL = 'INSERISCI_QUI_URL_APPS_SCRIPT'; 

        const apiKey = ""; 

        // --- VARIABILI GLOBALI ---
        let allProducts = [];
        let salesLog24h = new Map(); // Mappa ASIN -> Quantità venduta 24h
        let sortState = { column: 'qty24', direction: 'desc' };
        let currentEditingSku = null;
        let currentEditingField = null; 

        // Mapping CSV MAGAZZINO
        const COLS = {
            A_ASIN: 0, B: 1, C_SKU: 2, E_CAT: 4, F_BRAND: 5, H_QTY: 7, I_SCAFFALE: 8,
            Q_7G: 16, R_30G: 17, S_365G: 18, 
            AA: 26, AB_IMG: 27, AJ: 35
        };

        // --- ELEMENTI DOM ---
        let searchBox, categoryFilter, brandFilter, shelfFilter, statusMessage;
        let inventoryView, bestsellersView, navInventory, navBestsellers;
        let resultsContainer, tableBody, resultsCardsContainer;
        let bestsellersTableContainer, bestsellersTableBody, bestsellersCardsContainer;
        let productModal, modalContent, modalImg, modalSku, modalDetails, modalStock, geminiGenerateBtn, geminiResultContainer;
        let editModal, editInput, editModalInfo, saveBtn, saveBtnText, saveLoader;

        document.addEventListener('DOMContentLoaded', () => {
            // Assegnazione DOM
            searchBox = document.getElementById('search-box');
            categoryFilter = document.getElementById('filter-category');
            brandFilter = document.getElementById('filter-brand');
            shelfFilter = document.getElementById('filter-shelf');
            statusMessage = document.getElementById('status-message');
            inventoryView = document.getElementById('inventory-view');
            bestsellersView = document.getElementById('bestsellers-view');
            navInventory = document.getElementById('nav-inventory');
            navBestsellers = document.getElementById('nav-bestsellers');
            
            productModal = document.getElementById('product-modal');
            modalContent = document.getElementById('modal-content');
            modalImg = document.getElementById('modal-img');
            modalSku = document.getElementById('modal-sku');
            modalDetails = document.getElementById('modal-details');
            modalStock = document.getElementById('modal-stock');
            geminiGenerateBtn = document.getElementById('gemini-generate-btn');
            geminiResultContainer = document.getElementById('gemini-result-container');

            resultsContainer = document.getElementById('results-container');
            tableBody = document.getElementById('results-table-body');
            resultsCardsContainer = document.getElementById('results-cards-container');
            bestsellersTableContainer = document.getElementById('bestsellers-table-container');
            bestsellersTableBody = document.getElementById('bestsellers-table-body');
            bestsellersCardsContainer = document.getElementById('bestsellers-cards-container');

            // Nuova Modale Edit
            editModal = document.getElementById('edit-modal');
            editInput = document.getElementById('edit-input');
            editModalInfo = document.getElementById('edit-modal-info');
            saveBtn = document.getElementById('save-btn');
            saveBtnText = document.getElementById('save-btn-text');
            saveLoader = document.getElementById('save-loader');

            fetchData();
            
            searchBox.addEventListener('input', renderTable);
            categoryFilter.addEventListener('change', renderTable);
            brandFilter.addEventListener('change', renderTable);
            shelfFilter.addEventListener('change', renderTable);

            // Listener delegati
            const addDelegatedListener = (element, handler) => {
                if(element) element.addEventListener('click', handler);
            };

            addDelegatedListener(tableBody, handleInventoryClick);
            addDelegatedListener(resultsCardsContainer, handleInventoryClick); 
            addDelegatedListener(bestsellersTableBody, handleTableClick); 
            addDelegatedListener(bestsellersCardsContainer, handleTableClick);

            productModal.addEventListener('click', (e) => { if (e.target === productModal) closeProductModal(); });
            editModal.addEventListener('click', (e) => { if (e.target === editModal) closeEditModal(); });
        });

        // --- FETCH DATA (SCARICA ENTRAMBI I CSV) ---
        async function fetchData() {
            try {
                // Scarica entrambi i CSV in parallelo
                const [invResponse, logResponse] = await Promise.all([
                    fetch(CSV_URL),
                    fetch(LOG_VENDITE_URL)
                ]);

                if (!invResponse.ok) throw new Error("Errore Inventario");
                if (!logResponse.ok) throw new Error("Errore Log Vendite");

                const invText = await invResponse.text();
                const logText = await logResponse.text();

                // 1. Elabora Log Vendite per 24H
                processLogVendite(logText);

                // 2. Elabora Inventario Principale
                allProducts = parseCSV(invText);
                
                populateFilters();
                renderTable();
                renderBestSellers(); 
                
                statusMessage.classList.add('hidden');
                showView('inventory');
            } catch (error) {
                console.error('Errore:', error);
                statusMessage.innerHTML = `<span class="text-red-600">Impossibile caricare i dati.</span>`;
            }
        }

        // --- ELABORAZIONE LOG VENDITE (24H) ---
        function processLogVendite(text) {
            const lines = text.trim().split('\n');
            lines.shift(); // Header: DATA, ASIN, QTY
            
            const now = new Date();
            const oneDayMs = 24 * 60 * 60 * 1000;

            salesLog24h.clear();

            lines.forEach(line => {
                const cols = parseCSVLine(line);
                if (cols.length < 3) return;

                const dateStr = cols[0]; // "dd/mm/yyyy hh:mm"
                const asin = cols[1].trim();
                const qty = parseInt(cols[2]) || 0;

                // Parsing Data Personalizzato
                const [dPart, tPart] = dateStr.split(' ');
                if (!dPart || !tPart) return;
                const [day, month, year] = dPart.split('/');
                const [hour, min] = tPart.split(':');
                
                const entryDate = new Date(year, month - 1, day, hour, min);

                // Se rientra nelle 24 ore
                if (now - entryDate <= oneDayMs) {
                    const currentTotal = salesLog24h.get(asin) || 0;
                    salesLog24h.set(asin, currentTotal + qty);
                }
            });
        }

        // --- PARSING INVENTARIO ---
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            lines.shift(); 
            return lines.map(line => {
                const cols = parseCSVLine(line);
                const asin = cols[COLS.A_ASIN] || '';
                
                return {
                    sku: cols[COLS.C_SKU] || '',
                    asin: asin,
                    immagine: cols[COLS.AB_IMG] || '',
                    categoria: cols[COLS.E_CAT] || '',
                    brand: cols[COLS.F_BRAND] || '',
                    qty: cols[COLS.H_QTY] || '0',
                    scaffale: cols[COLS.I_SCAFFALE] || '',
                    // NUOVI DATI BEST SELLERS
                    qty24: salesLog24h.get(asin) || 0, // Dalla mappa 24h
                    qty7: parseInt(cols[COLS.Q_7G] || '0') || 0,
                    qty30: parseInt(cols[COLS.R_30G] || '0') || 0,
                    qty365: parseInt(cols[COLS.S_365G] || '0') || 0,
                    
                    searchData: [cols[COLS.A_ASIN], cols[COLS.B], cols[COLS.C_SKU], cols[COLS.E_CAT], cols[COLS.F_BRAND], cols[COLS.AA], cols[COLS.AJ]].join(' ').toLowerCase()
                };
            }).filter(p => p.sku); 
        }

        function parseCSVLine(line) {
            const values = []; let inQuote = false; let currentValue = '';
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuote && line[i+1] === '"') { currentValue += '"'; i++; } else { inQuote = !inQuote; }
                } else if (char === ',' && !inQuote) {
                    values.push(currentValue.trim().replace(/^"|"$/g, '')); currentValue = '';
                } else { currentValue += char; }
            }
            values.push(currentValue.trim().replace(/^"|"$/g, '')); return values;
        }

        function populateFilters() {
            const categories = new Set(); const brands = new Set(); const shelves = new Set();
            allProducts.forEach(p => {
                if (p.categoria) categories.add(p.categoria);
                if (p.brand) brands.add(p.brand);
                if (p.scaffale) shelves.add(p.scaffale);
            });
            const fill = (el, items) => {
                if (!el) return;
                [...items].sort().forEach(i => { const o = document.createElement('option'); o.value = i; o.textContent = i; el.appendChild(o); });
            };
            fill(categoryFilter, categories); fill(brandFilter, brands); fill(shelfFilter, shelves);
        }

        // --- RENDER TABLE INVENTARIO (INVARIATO) ---
        function renderTable() {
            if (!searchBox) return;
            const term = searchBox.value.toLowerCase().trim();
            const keywords = term.split(' ').filter(k => k);
            const cat = categoryFilter.value; const br = brandFilter.value; const sh = shelfFilter.value;

            let filtered = allProducts.filter(p => {
                return (!cat || p.categoria === cat) && (!br || p.brand === br) && (!sh || p.scaffale === sh);
            });

            if (keywords.length > 0) {
                filtered = filtered.filter(p => keywords.every(k => p.searchData.includes(k)));
            }
            
            tableBody.innerHTML = ''; resultsCardsContainer.innerHTML = ''; 

            if (filtered.length === 0) {
                if (!statusMessage.classList.contains('hidden')) statusMessage.classList.add('hidden');
                resultsContainer.classList.add('hidden'); resultsCardsContainer.classList.add('hidden');
                statusMessage.innerHTML = `<div class="p-8 text-center text-gray-500">Nessun prodotto trovato.</div>`;
                statusMessage.classList.remove('hidden');
            } else {
                statusMessage.classList.add('hidden');
                resultsContainer.classList.remove('hidden'); resultsCardsContainer.classList.remove('hidden');

                const isSingleResult = filtered.length === 1;
                let tableHtml = []; let cardsHtml = [];

                filtered.forEach(p => {
                    const img = `https://placehold.co/150x150/FD991F/white?text=${p.sku[0] || '?'}`;
                    const imgMob = `https://placehold.co/300x300/FD991F/white?text=${p.sku[0] || '?'}`;

                    tableHtml.push(`
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="p-3">
                                <img src="${p.immagine || img}" class="w-[150px] h-[150px] object-contain rounded-md shadow-sm bg-white" onerror="this.onerror=null; this.src='${img}';">
                            </td>
                            <td class="p-3 skugls"><button class="sku-button" data-sku="${p.sku}">${p.sku}</button></td>
                            <td class="p-3 text-sm text-gray-700">${p.categoria}</td>
                            <td class="p-3 text-2xl font-bold text-gray-900">${p.brand}</td>
                            <td class="p-3 text-3xl font-bold text-center editable-cell" onclick="openEditModal('${p.sku}', 'qty', '${p.qty}')" title="Clicca per modificare">${p.qty}</td>
                            <td class="p-3 text-5xl font-bold text-brand-orange leading-tight break-words max-w-[300px] editable-cell" onclick="openEditModal('${p.sku}', 'scaffale', '${p.scaffale}')" title="Clicca per modificare">${p.scaffale}</td>
                        </tr>
                    `);

                    if (isSingleResult) {
                        cardsHtml.push(`
                            <div class="p-6 flex flex-col items-center text-center space-y-6">
                                <div class="w-full bg-white rounded-xl p-4 border border-gray-100"><img src="${p.immagine || imgMob}" class="w-full max-w-[300px] mx-auto object-contain" onerror="this.src='${imgMob}'"></div>
                                <div class="w-full">
                                    <button class="sku-button w-full text-center" data-sku="${p.sku}"><h2 class="text-3xl font-bold text-brand-orange break-all">${p.sku}</h2></button>
                                    <p class="text-xl font-medium text-gray-900 mt-2">${p.brand}</p>
                                    <div class="mt-6 grid grid-cols-2 gap-4 bg-gray-50 rounded-xl p-4 border border-gray-200">
                                        <div class="flex flex-col editable-cell p-2 rounded" onclick="openEditModal('${p.sku}', 'qty', '${p.qty}')">
                                            <span class="text-sm text-gray-500 uppercase font-semibold">Quantità ✏️</span>
                                            <span class="text-3xl font-bold text-gray-900">${p.qty}</span>
                                        </div>
                                        <div class="flex flex-col editable-cell p-2 rounded" onclick="openEditModal('${p.sku}', 'scaffale', '${p.scaffale}')">
                                            <span class="text-sm text-gray-500 uppercase font-semibold">Scaffale ✏️</span>
                                            <span class="text-5xl font-bold text-brand-orange break-words text-center leading-tight">${p.scaffale || '-'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `);
                    } else {
                        cardsHtml.push(`
                            <div class="flex p-4 border-b border-gray-200 last:border-b-0">
                                <div class="flex-shrink-0 w-[120px] h-[120px] bg-white rounded-md border border-gray-100 flex items-center justify-center p-1">
                                    <img src="${p.immagine || img}" class="w-full h-full object-contain" onerror="this.src='${img}'">
                                </div>
                                <div class="ml-4 flex-grow flex flex-col justify-center min-w-0">
                                    <button class="sku-button" data-sku="${p.sku}"><h3 class="text-lg font-bold text-brand-orange truncate">${p.sku}</h3></button>
                                    <p class="text-sm font-medium text-gray-900 truncate">${p.brand}</p>
                                    <p class="text-base font-semibold text-gray-800 mt-1 editable-cell w-max" onclick="openEditModal('${p.sku}', 'qty', '${p.qty}')">QTY: ${p.qty} ✏️</p>
                                    <p class="text-2xl font-bold text-gray-700 mt-1 editable-cell w-max" onclick="openEditModal('${p.sku}', 'scaffale', '${p.scaffale}')">Scaff: ${p.scaffale || '-'} ✏️</p>
                                </div>
                            </div>
                        `);
                    }
                });
                tableBody.innerHTML = tableHtml.join('');
                resultsCardsContainer.innerHTML = cardsHtml.join('');
            }
        }

        // --- GESTIONE EDIT (INVARIATA) ---
        function handleInventoryClick(e) {
            if (e.target.closest('.sku-button')) {
                const sku = e.target.closest('.sku-button').dataset.sku;
                openProductModal(sku);
            }
        }

        function handleTableClick(e) {
             const button = e.target.closest('.sku-button');
             if(button) openProductModal(button.dataset.sku);
        }

        function openEditModal(sku, field, value) {
            currentEditingSku = sku;
            currentEditingField = field;
            let label = field === 'qty' ? 'Quantità' : 'Scaffale';
            editModalInfo.textContent = `Modifica ${label} per SKU: ${sku}`;
            editInput.value = value === 'undefined' ? '' : value;
            editModal.classList.remove('hidden');
            editInput.focus();
        }

        function closeEditModal() { editModal.classList.add('hidden'); }

        async function saveEdit() {
            if (APPS_SCRIPT_URL === 'INSERISCI_QUI_URL_APPS_SCRIPT') { alert("Errore script non configurato"); return; }
            const newValue = editInput.value;
            saveBtn.disabled = true; saveBtnText.textContent = "Salvataggio..."; saveLoader.classList.remove('hidden');
            try {
                const payload = JSON.stringify({ sku: currentEditingSku, field: currentEditingField, value: newValue });
                await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: payload });
                const product = allProducts.find(p => p.sku === currentEditingSku);
                if (product) { if (currentEditingField === 'qty') product.qty = newValue; if (currentEditingField === 'scaffale') product.scaffale = newValue; }
                closeEditModal(); renderTable(); 
            } catch (error) { alert("Errore salvataggio"); } 
            finally { saveBtn.disabled = false; saveBtnText.textContent = "Salva Modifiche"; saveLoader.classList.add('hidden'); }
        }

        function showView(viewName) {
            if (!inventoryView || !bestsellersView) return;
            if (viewName === 'inventory') {
                inventoryView.classList.remove('hidden'); bestsellersView.classList.add('hidden');
                document.getElementById('results-container').parentElement.classList.remove('hidden');
                navInventory.className = 'text-lg font-semibold text-brand-orange border-b-2 border-brand-orange pb-1 transition-all';
                navBestsellers.className = 'text-lg font-semibold text-brand-gray hover:text-brand-orange transition-all';
            } else {
                inventoryView.classList.add('hidden'); bestsellersView.classList.remove('hidden');
                document.getElementById('results-container').parentElement.classList.add('hidden');
                if(statusMessage) statusMessage.classList.add('hidden');
                navInventory.className = 'text-lg font-semibold text-brand-gray hover:text-brand-orange transition-all';
                navBestsellers.className = 'text-lg font-semibold text-brand-orange border-b-2 border-brand-orange pb-1 transition-all';
                renderBestSellers();
            }
        }

        // --- RENDER BEST SELLERS (AGGIORNATA) ---
        function sortBestSellers(col) {
            if (sortState.column === col) sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            else { sortState.column = col; sortState.direction = 'desc'; }
            renderBestSellers();
        }

        function renderBestSellers() {
            if (!bestsellersTableBody) return;
            // Filtra: mostra solo se ha vendite in almeno uno dei periodi
            const data = allProducts.filter(p => p.qty24 > 0 || p.qty7 > 0 || p.qty30 > 0 || p.qty365 > 0);
            
            data.sort((a, b) => sortState.direction === 'asc' ? a[sortState.column] - b[sortState.column] : b[sortState.column] - a[sortState.column]);
            
            // Reset arrows
            ['24h', '7g', '30g', '365g'].forEach(id => {
                const el = document.getElementById(`sort-arrow-${id}`);
                if(el) el.textContent = '';
            });
            const arrow = sortState.direction === 'asc' ? ' ↑' : ' ↓';
            const mapId = { 'qty24': '24h', 'qty7': '7g', 'qty30': '30g', 'qty365': '365g' };
            const el = document.getElementById(`sort-arrow-${mapId[sortState.column]}`);
            if(el) el.textContent = arrow;

            bestsellersTableBody.innerHTML = ''; bestsellersCardsContainer.innerHTML = '';
            if (data.length === 0) {
                 bestsellersTableBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-500">Nessun dato Best Seller trovato.</td></tr>`;
                 bestsellersCardsContainer.innerHTML = `<div class="p-8 text-center text-gray-500">Nessun dato Best Seller trovato.</div>`;
                 bestsellersTableContainer.classList.remove('hidden'); bestsellersCardsContainer.classList.remove('hidden');
                 return;
            }

            bestsellersTableContainer.classList.remove('hidden'); bestsellersCardsContainer.classList.remove('hidden');
            let tblHtml = []; let cardHtml = [];
            
            data.forEach(p => {
                const img = `https://placehold.co/150x150/FD991F/white?text=${p.sku[0] || '?'}`;
                
                // TABELLA DESKTOP
                tblHtml.push(`
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="p-3"><img src="${p.immagine || img}" class="w-[150px] h-[150px] object-contain rounded-md shadow-sm bg-white" onerror="this.src='${img}'"></td>
                        <td class="p-3 skugls"><button class="sku-button" data-sku="${p.sku}">${p.sku}</button></td>
                        <td class="p-3 text-lg font-bold text-center text-red-600">${p.qty24}</td>
                        <td class="p-3 text-lg font-semibold text-center">${p.qty7}</td>
                        <td class="p-3 text-lg font-semibold text-center">${p.qty30}</td>
                        <td class="p-3 text-lg font-semibold text-center">${p.qty365}</td>
                    </tr>
                `);

                // CARD MOBILE (Griglia 2x2 per i dati)
                cardHtml.push(`
                    <div class="flex flex-col p-4 border-b border-gray-200 last:border-b-0">
                        <div class="flex items-center mb-4">
                            <div class="flex-shrink-0 w-[100px] h-[100px] bg-white rounded-md border border-gray-100 flex items-center justify-center p-1">
                                <img src="${p.immagine || img}" class="w-full h-full object-contain" onerror="this.src='${img}'">
                            </div>
                            <div class="ml-4 flex-grow min-w-0">
                                <button class="sku-button" data-sku="${p.sku}"><h3 class="text-lg font-bold text-brand-orange truncate">${p.sku}</h3></button>
                                <p class="text-sm font-medium text-gray-900 truncate">${p.brand}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 gap-2 text-center bg-gray-50 p-2 rounded-lg">
                            <div><div class="text-xs text-gray-500">24H</div><div class="text-lg font-bold text-red-600">${p.qty24}</div></div>
                            <div><div class="text-xs text-gray-500">7G</div><div class="text-lg font-semibold">${p.qty7}</div></div>
                            <div><div class="text-xs text-gray-500">30G</div><div class="text-lg font-semibold">${p.qty30}</div></div>
                            <div><div class="text-xs text-gray-500">365G</div><div class="text-lg font-semibold">${p.qty365}</div></div>
                        </div>
                    </div>
                `);
            });
            bestsellersTableBody.innerHTML = tblHtml.join('');
            bestsellersCardsContainer.innerHTML = cardHtml.join('');
        }

        function openProductModal(sku) {
            const p = allProducts.find(x => x.sku === sku); if(!p) return;
            const img = `https://placehold.co/150x150/FD991F/white?text=${p.sku[0] || '?'}`;
            modalImg.src = p.immagine || img; modalImg.onerror = () => modalImg.src = img;
            modalSku.textContent = p.sku;
            modalDetails.textContent = `Brand: ${p.brand} | Cat: ${p.categoria}`;
            modalStock.textContent = `Mag: ${p.qty} | Scaff: ${p.scaffale}`;
            geminiResultContainer.innerHTML = 'Clicca per descrizione...'; geminiGenerateBtn.disabled = false;
            geminiGenerateBtn.onclick = () => callGeminiForProduct(p);
            productModal.classList.remove('hidden');
        }
        function closeProductModal() { productModal.classList.add('hidden'); }

        async function callGeminiForProduct(product) {
            geminiGenerateBtn.disabled = true; geminiResultContainer.innerHTML = "Generazione...";
            // Logica Gemini omessa per brevità
        }
    </script>
</body>
</html>
