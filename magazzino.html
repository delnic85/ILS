
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ricerca Magazzino - I LOVE SHOPPING</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Stile personalizzato per definire i colori del brand e il font */
        :root {
            --brand-orange: #FD991F; /* Colore arancione primario */
            --brand-gray: #7A8686; /* Colore grigio secondario */
        }
        
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Stile per lo spinner di caricamento */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: var(--brand-orange);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .skugls { 
            width: 150px; 
            overflow-wrap: break-word; /* Manda a capo il testo */
            word-break: break-all; /* Evita overflow per SKU lunghi */
        }
        
        /* Stile per il pulsante SKU cliccabile */
        .sku-button {
            font-weight: 500;
            color: var(--brand-orange);
            text-decoration: none;
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            transition: all 0.2s ease;
            /* Aggiunto per la vista card */
            text-align: left; 
            width: 100%;
        }
        .sku-button:hover {
            text-decoration: underline;
            color: #E48A1A; /* Un arancione più scuro per l'hover */
        }

        /* Stile per il pulsante Gemini */
        .gemini-button {
            background-color: var(--brand-orange);
            color: white;
            font-weight: 600;
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .gemini-button:hover {
            background-color: #E48A1A;
        }
        .gemini-button:disabled {
            background-color: #fcae4a;
            cursor: not-allowed;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    
    <script>
        // Configurazione Tailwind per i colori personalizzati
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-orange': 'var(--brand-orange)',
                        'brand-gray': 'var(--brand-gray)',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 text-brand-gray min-h-screen antialiased">

    <div class="container mx-auto max-w-7xl p-4 md:p-8">

        <nav class="flex justify-end gap-6 mb-4">
            <button id="nav-inventory" onclick="showView('inventory')" 
                    class="text-lg font-semibold text-brand-orange border-b-2 border-brand-orange pb-1 transition-all">
                Ricerca Magazzino
            </button>
            <button id="nav-bestsellers" onclick="showView('bestsellers')" 
                    class="text-lg font-semibold text-brand-gray hover:text-brand-orange transition-all">
                BEST SELLERS
            </button>
        </nav>
        
        <div id="inventory-view">
            <header class="flex items-center justify-center gap-4 mb-8">
                    <h1 class="text-3xl md:text-5xl font-bold text-brand-orange tracking-tight">
                        I LOVE SHOPPING
                    </h1>
            </header> 

            <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 mb-8">
                <div class="mb-8">
                    <label for="search-box" class="sr-only">Cerca</label>
                    <input type="text" id="search-box" 
                            placeholder="Cerca per SKU, nome, categoria, brand..." 
                            class="w-full p-4 border border-gray-300 rounded-lg text-lg shadow-sm
                                     focus:outline-none focus:ring-2 focus:ring-brand-orange focus:border-transparent">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="filter-category" class="block text-sm font-medium text-gray-700 mb-2">Categoria</label>
                        <select id="filter-category" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white
                                                            focus:outline-none focus:ring-2 focus:ring-brand-orange focus:border-transparent">
                            <option value="">Tutte le categorie</option>
                        </select>
                    </div>
                    <div>
                        <label for="filter-brand" class="block text-sm font-medium text-gray-700 mb-2">Brand</label>
                        <select id="filter-brand" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white
                                                         focus:outline-none focus:ring-2 focus:ring-brand-orange focus:border-transparent">
                            <option value="">Tutti i brand</option>
                        </select>
                    </div>
                    <div>
                        <label for="filter-shelf" class="block text-sm font-medium text-gray-700 mb-2">Scaffale</label>
                        <select id="filter-shelf" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white
                                                         focus:outline-none focus:ring-2 focus:ring-brand-orange focus:border-transparent">
                            <option value="">Tutti gli scaffali</option>
                        </select>
                    </div>
                </div>
            </div>
        </div> <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div id="status-message" class="p-8 text-center">
                <div class="flex flex-col items-center justify-center space-y-4">
                    <span class="loader"></span>
                    <span class="text-gray-500 font-medium">Caricamento dati dal magazzino...</span>
                </div>
            </div>

            <div id="results-container" class="overflow-x-auto hidden md:block">
                <table class="w-full min-w-max">
                    <thead class="bg-brand-gray text-white sticky top-0">
                        <tr>
                            <th class="p-4 text-left text-sm font-semibold uppercase tracking-wider">Immagine</th>
                            <th class="p-4 skugls text-left text-sm font-semibold uppercase tracking-wider">SKU GLS</th>
                            <th class="p-4 text-left text-sm font-semibold uppercase tracking-wider">Categoria</th>
                            <th class="p-4 text-left text-sm font-semibold uppercase tracking-wider">Brand</th>
                            <th class="p-4 text-left text-sm font-semibold uppercase tracking-wider">QTY Mag</th>
                            <th class="p-4 text-left text-sm font-semibold uppercase tracking-wider">Scaffale</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body" class="divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>

            <div id="results-cards-container" class="block md:hidden">
                </div>
            
        </div> <div id="bestsellers-view" class="hidden">
            <header class="flex items-center justify-center gap-4 mb-8">
                <h1 class="text-3xl md:text-5xl font-bold text-brand-orange tracking-tight">
                    Best Sellers
                </h1>
            </header>

            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            
                <div id="bestsellers-table-container" class="overflow-x-auto hidden md:block">
                    <table class="w-full min-w-max">
                        <thead class="bg-brand-gray text-white sticky top-0">
                            <tr>
                                <th class="p-4 text-left text-sm font-semibold uppercase tracking-wider">Immagine</th>
                                <th class="p-4 skugls text-left text-sm font-semibold uppercase tracking-wider">SKU GLS</th>
                                <th id="th-amazon" onclick="sortBestSellers('amazonQty')" 
                                    class="p-4 text-left text-sm font-semibold uppercase tracking-wider cursor-pointer hover:bg-opacity-80">
                                    AMAZON <span id="sort-arrow-amazon"></span>
                                </th>
                                <th id="th-temu" onclick="sortBestSellers('temuQty')" 
                                    class="p-4 text-left text-sm font-semibold uppercase tracking-wider cursor-pointer hover:bg-opacity-80">
                                    TEMU <span id="sort-arrow-temu"></span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="bestsellers-table-body" class="divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>

                <div id="bestsellers-cards-container" class="block md:hidden">
                    </div>
            </div>

        </div> </div>

    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 relative" id="modal-content">
            <button onclick="closeProductModal()" class="absolute top-4 right-4 text-3xl text-brand-gray hover:text-black">&times;</button>
            
            <h2 class="text-2xl font-bold text-brand-orange mb-4">Dettagli Prodotto</h2>
            
            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex-shrink-0">
                    <img id="modal-img" src="" alt="Immagine prodotto" class="w-[150px] h-[150px] object-contain rounded-lg bg-white">
                </div>
                
                <div class="flex-grow">
                    <h3 id="modal-sku" class="text-xl font-semibold text-gray-900"></h3>
                    <p id="modal-details" class="text-md text-brand-gray mt-1"></p>
                    <p id="modal-stock" class="text-md text-brand-gray mt-1"></p>
                </div>
            </div>

            <div class="mt-6 border-t border-gray-200 pt-6">
                <button id="gemini-generate-btn" class="gemini-button">
                    ✨ Genera Descrizione Prodotto
                </button>
                
                <div id="gemini-result-container" class="mt-4 bg-gray-50 p-4 rounded-lg min-h-[60px] text-gray-700 text-sm">
                    </div>
            </div>
        </div>
    </div>


    <script>
        // URL del tuo Google Sheet
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQLf2HBC2g4q3L-hER7WPpYixWIIqJyV6MAkWm4ENZlQNrLxbroZRP3HBZ7Uzl510OVON8q590_YH_S/pub?gid=938359466&single=true&output=csv';

        // --- Riferimenti agli elementi DOM ---
        let searchBox, categoryFilter, brandFilter, shelfFilter, statusMessage;
        let inventoryView, bestsellersView, navInventory, navBestsellers;
        let thAmazon, thTemu, sortArrowAmazon, sortArrowTemu;

        // --- Elementi Modale ---
        let productModal, modalContent, modalImg, modalSku, modalDetails, modalStock, geminiGenerateBtn, geminiResultContainer;

        // --- NUOVI Elementi Responsive ---
        let resultsContainer, tableBody, resultsCardsContainer;
        let bestsellersTableContainer, bestsellersTableBody, bestsellersCardsContainer;

        // --- API KEY per Gemini ---
        const apiKey = ""; 

        let allProducts = [];
        let sortState = { column: 'amazonQty', direction: 'desc' };

        const COLS = {
            A: 0, B: 1, C_SKU: 2, E_CAT: 4, F_BRAND: 5, H_QTY: 7, I_SCAFFALE: 8,
            P_AMAZON: 15, R_TEMU: 17, AA: 26, AB_IMG: 27, AJ: 35
        };

        document.addEventListener('DOMContentLoaded', () => {
            
            searchBox = document.getElementById('search-box');
            categoryFilter = document.getElementById('filter-category');
            brandFilter = document.getElementById('filter-brand');
            shelfFilter = document.getElementById('filter-shelf');
            statusMessage = document.getElementById('status-message');
            
            inventoryView = document.getElementById('inventory-view');
            bestsellersView = document.getElementById('bestsellers-view');
            navInventory = document.getElementById('nav-inventory');
            navBestsellers = document.getElementById('nav-bestsellers');
            
            thAmazon = document.getElementById('th-amazon');
            thTemu = document.getElementById('th-temu');
            sortArrowAmazon = document.getElementById('sort-arrow-amazon');
            sortArrowTemu = document.getElementById('sort-arrow-temu');
            
            productModal = document.getElementById('product-modal');
            modalContent = document.getElementById('modal-content');
            modalImg = document.getElementById('modal-img');
            modalSku = document.getElementById('modal-sku');
            modalDetails = document.getElementById('modal-details');
            modalStock = document.getElementById('modal-stock');
            geminiGenerateBtn = document.getElementById('gemini-generate-btn');
            geminiResultContainer = document.getElementById('gemini-result-container');

            resultsContainer = document.getElementById('results-container');
            tableBody = document.getElementById('results-table-body');
            resultsCardsContainer = document.getElementById('results-cards-container');
            
            bestsellersTableContainer = document.getElementById('bestsellers-table-container');
            bestsellersTableBody = document.getElementById('bestsellers-table-body');
            bestsellersCardsContainer = document.getElementById('bestsellers-cards-container');

            fetchData();
            
            searchBox.addEventListener('input', renderTable);
            categoryFilter.addEventListener('change', renderTable);
            brandFilter.addEventListener('change', renderTable);
            shelfFilter.addEventListener('change', renderTable);

            tableBody.addEventListener('click', handleTableClick);
            resultsCardsContainer.addEventListener('click', handleTableClick);
            bestsellersTableBody.addEventListener('click', handleTableClick);
            bestsellersCardsContainer.addEventListener('click', handleTableClick);

            productModal.addEventListener('click', (e) => {
                if (e.target === productModal) {
                    closeProductModal();
                }
            });
        });

        async function fetchData() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) {
                    throw new Error(`Errore HTTP: ${response.status}`);
                }
                const csvText = await response.text();
                allProducts = parseCSV(csvText);
                
                populateFilters();
                renderTable();
                renderBestSellers(); 
                
                statusMessage.classList.add('hidden');
                showView('inventory');

            } catch (error) {
                console.error('Errore nel caricamento dei dati:', error);
                statusMessage.innerHTML = `<span class="text-red-600 font-medium">Impossibile caricare i dati dal magazzino. Riprova più tardi.</span>`;
            }
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            lines.shift(); 
            
            const products = lines.map(line => {
                const cols = parseCSVLine(line);
                return {
                    sku: cols[COLS.C_SKU] || '',
                    immagine: cols[COLS.AB_IMG] || '',
                    categoria: cols[COLS.E_CAT] || '',
                    brand: cols[COLS.F_BRAND] || '',
                    qty: cols[COLS.H_QTY] || '0',
                    scaffale: cols[COLS.I_SCAFFALE] || '',
                    amazonQty: parseInt(cols[COLS.P_AMAZON] || '0') || 0,
                    temuQty: parseInt(cols[COLS.R_TEMU] || '0') || 0,
                    searchData: [
                        cols[COLS.A], cols[COLS.B], cols[COLS.C_SKU], cols[COLS.E_CAT], 
                        cols[COLS.F_BRAND], cols[COLS.AA], cols[COLS.AJ]
                    ].join(' ').toLowerCase()
                };
            }).filter(p => p.sku); 

            return products;
        }

        function parseCSVLine(line) {
            const values = [];
            let inQuote = false;
            let currentValue = '';

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuote && line[i+1] === '"') {
                        currentValue += '"';
                        i++; 
                    } else {
                        inQuote = !inQuote;
                    }
                } else if (char === ',' && !inQuote) {
                    values.push(currentValue.trim().replace(/^"|"$/g, ''));
                    currentValue = '';
                } else {
                    currentValue += char;
                }
            }
            values.push(currentValue.trim().replace(/^"|"$/g, ''));
            return values;
        }

        function populateFilters() {
            const categories = new Set();
            const brands = new Set();
            const shelves = new Set();

            allProducts.forEach(p => {
                if (p.categoria) categories.add(p.categoria);
                if (p.brand) brands.add(p.brand);
                if (p.scaffale) shelves.add(p.scaffale);
            });

            const fillSelect = (selectEl, items) => {
                if (!selectEl) return;
                const sortedItems = [...items].sort((a, b) => a.localeCompare(b));
                sortedItems.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    selectEl.appendChild(option);
                });
            };

            fillSelect(categoryFilter, categories);
            fillSelect(brandFilter, brands);
            fillSelect(shelfFilter, shelves);
        }

        // ==============================================
        // LOGICA RENDERIZZAZIONE RICERCA (MODIFICATA)
        // ==============================================
        function renderTable() {
            if (!searchBox || !tableBody || !statusMessage || !resultsContainer) return;

            const searchTerm = searchBox.value.toLowerCase().trim();
            const keywords = searchTerm.split(' ').filter(k => k);
            const selectedCategory = categoryFilter.value;
            const selectedBrand = brandFilter.value;
            const selectedShelf = shelfFilter.value;

            let filteredProducts = allProducts.filter(p => {
                const catMatch = !selectedCategory || p.categoria === selectedCategory;
                const brandMatch = !selectedBrand || p.brand === selectedBrand;
                const shelfMatch = !selectedShelf || p.scaffale === selectedShelf;
                return catMatch && brandMatch && shelfMatch;
            });

            if (keywords.length > 0) {
                filteredProducts = filteredProducts.filter(p => {
                    return keywords.every(keyword => p.searchData.includes(keyword));
                });
            }
            
            tableBody.innerHTML = '';
            resultsCardsContainer.innerHTML = ''; 

            if (filteredProducts.length === 0) {
                if (!statusMessage.classList.contains('hidden')) statusMessage.classList.add('hidden'); 
                resultsContainer.classList.add('hidden');
                resultsCardsContainer.classList.add('hidden');
                statusMessage.innerHTML = `<div class="p-8 text-center text-gray-500">Nessun prodotto trovato.</div>`;
                statusMessage.classList.remove('hidden');
            } else {
                statusMessage.classList.add('hidden');
                resultsContainer.classList.remove('hidden');
                resultsCardsContainer.classList.remove('hidden');

                // LOGICA: Se c'è UN SOLO prodotto, mostra il layout GIGANTE
                const isSingleResult = filteredProducts.length === 1;

                let tableRowsHtml = [];
                let cardsHtml = [];

                filteredProducts.forEach(p => {
                    const placeholderImg = `https://placehold.co/150x150/FD991F/white?text=${p.sku[0] || '?'}`;
                    const placeholderImgMobile = `https://placehold.co/300x300/FD991F/white?text=${p.sku[0] || '?'}`; // Img più grande per fallback

                    // --- HTML per la TABELLA (Desktop - resta simile) ---
                    tableRowsHtml.push(`
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="p-3">
                                <img src="${p.immagine || placeholderImg}" 
                                     alt="Immagine prodotto"
                                     class="w-[150px] h-[150px] object-contain rounded-md shadow-sm bg-white"
                                     onerror="this.onerror=null; this.src='${placeholderImg}';">
                            </td>
                            <td class="p-3 skugls">
                                <button class="sku-button" data-sku="${p.sku}">${p.sku}</button>
                            </td>
                            <td class="p-3 text-sm text-gray-700">${p.categoria}</td>
                            <td class="p-3 text-sm font-medium text-gray-900">${p.brand}</td>
                            <td class="p-3 text-lg font-semibold text-center">${p.qty}</td>
                            <td class="p-3 text-sm text-gray-700">${p.scaffale}</td>
                        </tr>
                    `);

                    // --- HTML per la CARD MOBILE (Logica Differenziata) ---
                    if (isSingleResult) {
                        // *** LAYOUT RISULTATO SINGOLO (Gigante) ***
                        cardsHtml.push(`
                            <div class="p-6 flex flex-col items-center text-center space-y-6">
                                <div class="w-full bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                                    <img src="${p.immagine || placeholderImgMobile}" 
                                         alt="Immagine prodotto"
                                         class="w-full max-w-[300px] mx-auto object-contain"
                                         onerror="this.onerror=null; this.src='${placeholderImgMobile}';">
                                </div>
                                
                                <div class="w-full">
                                    <button class="sku-button w-full text-center" data-sku="${p.sku}">
                                        <h2 class="text-3xl font-bold text-brand-orange break-all">${p.sku}</h2>
                                    </button>
                                    <p class="text-xl font-medium text-gray-900 mt-2">${p.brand}</p>
                                    
                                    <div class="mt-6 grid grid-cols-2 gap-4 bg-gray-50 rounded-xl p-4 border border-gray-200">
                                        <div class="flex flex-col">
                                            <span class="text-sm text-gray-500 uppercase font-semibold">Quantità</span>
                                            <span class="text-3xl font-bold text-gray-900">${p.qty}</span>
                                        </div>
                                        <div class="flex flex-col">
                                            <span class="text-sm text-gray-500 uppercase font-semibold">Scaffale</span>
                                            <span class="text-5xl font-bold text-brand-orange">${p.scaffale || '-'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `);
                    } else {
                        // *** LAYOUT LISTA STANDARD (Uniformato 120px + Info a destra) ***
                        cardsHtml.push(`
                            <div class="flex p-4 border-b border-gray-200 last:border-b-0">
                                <div class="flex-shrink-0 w-[120px] h-[120px] bg-white rounded-md border border-gray-100 flex items-center justify-center p-1">
                                    <img src="${p.immagine || placeholderImg}" 
                                         alt="Immagine"
                                         class="w-full h-full object-contain"
                                         onerror="this.onerror=null; this.src='${placeholderImg}';">
                                </div>
                                
                                <div class="ml-4 flex-grow flex flex-col justify-center min-w-0">
                                    <button class="sku-button" data-sku="${p.sku}">
                                        <h3 class="text-lg font-bold text-brand-orange truncate">${p.sku}</h3>
                                    </button>
                                    <p class="text-sm font-medium text-gray-900 truncate">${p.brand}</p>
                                    <p class="text-base font-semibold text-gray-800 mt-1">QTY: ${p.qty}</p>
                                    <p class="text-2xl font-bold text-gray-700 mt-1">Scaff: ${p.scaffale || '-'}</p>
                                </div>
                            </div>
                        `);
                    }
                });
                
                tableBody.innerHTML = tableRowsHtml.join('');
                resultsCardsContainer.innerHTML = cardsHtml.join('');
            }
        }

        function showView(viewName) {
            if (!inventoryView || !bestsellersView || !navInventory || !navBestsellers) return;

            if (viewName === 'inventory') {
                inventoryView.classList.remove('hidden');
                bestsellersView.classList.add('hidden');
                document.getElementById('results-container').parentElement.classList.remove('hidden');
                navInventory.className = 'text-lg font-semibold text-brand-orange border-b-2 border-brand-orange pb-1 transition-all';
                navBestsellers.className = 'text-lg font-semibold text-brand-gray hover:text-brand-orange transition-all';

            } else if (viewName === 'bestsellers') {
                inventoryView.classList.add('hidden');
                bestsellersView.classList.remove('hidden');
                document.getElementById('results-container').parentElement.classList.add('hidden');
                if(statusMessage) statusMessage.classList.add('hidden');
                navInventory.className = 'text-lg font-semibold text-brand-gray hover:text-brand-orange transition-all';
                navBestsellers.className = 'text-lg font-semibold text-brand-orange border-b-2 border-brand-orange pb-1 transition-all';
                renderBestSellers();
            }
        }

        function sortBestSellers(column) {
            if (sortState.column === column) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = column;
                sortState.direction = 'desc';
            }
            renderBestSellers();
        }

        function renderBestSellers() {
            if (!bestsellersTableBody || !sortArrowAmazon || !sortArrowTemu) return;
            
            const bestSellersData = allProducts.filter(p => p.amazonQty > 0 || p.temuQty > 0);

            bestSellersData.sort((a, b) => {
                const valA = a[sortState.column];
                const valB = b[sortState.column];
                return (sortState.direction === 'asc') ? (valA - valB) : (valB - valA);
            });

            sortArrowAmazon.textContent = '';
            sortArrowTemu.textContent = '';
            const arrow = sortState.direction === 'asc' ? ' ↑' : ' ↓';
            if (sortState.column === 'amazonQty') {
                sortArrowAmazon.textContent = arrow;
            } else {
                sortArrowTemu.textContent = arrow;
            }

            bestsellersTableBody.innerHTML = '';
            bestsellersCardsContainer.innerHTML = '';
            
            if (bestSellersData.length === 0) {
                 bestsellersTableBody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-500">Nessun dato Best Seller trovato.</td></tr>`;
                 bestsellersCardsContainer.innerHTML = `<div class="p-8 text-center text-gray-500">Nessun dato Best Seller trovato.</div>`;
                 bestsellersTableContainer.classList.remove('hidden');
                 bestsellersCardsContainer.classList.remove('hidden');
                 return;
            }

            bestsellersTableContainer.classList.remove('hidden');
            bestsellersCardsContainer.classList.remove('hidden');

            let tableRowsHtml = [];
            let cardsHtml = [];

            bestSellersData.forEach(p => {
                const placeholderImg = `https://placehold.co/150x150/FD991F/white?text=${p.sku[0] || '?'}`;
                
                // Desktop
                tableRowsHtml.push(`
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="p-3">
                            <img src="${p.immagine || placeholderImg}" 
                                 alt="Immagine"
                                 class="w-[150px] h-[150px] object-contain rounded-md shadow-sm bg-white"
                                 onerror="this.onerror=null; this.src='${placeholderImg}';">
                        </td>
                        <td class="p-3 skugls">
                            <button class="sku-button" data-sku="${p.sku}">${p.sku}</button>
                        </td>
                        <td class="p-3 text-lg font-semibold text-center">${p.amazonQty}</td>
                        <td class="p-3 text-lg font-semibold text-center">${p.temuQty}</td>
                    </tr>
                `);

                // Mobile Card (Applicata stessa logica 120px)
                cardsHtml.push(`
                    <div class="flex p-4 border-b border-gray-200 last:border-b-0">
                        <div class="flex-shrink-0 w-[120px] h-[120px] bg-white rounded-md border border-gray-100 flex items-center justify-center p-1">
                            <img src="${p.immagine || placeholderImg}" 
                                 alt="Immagine"
                                 class="w-full h-full object-contain"
                                 onerror="this.onerror=null; this.src='${placeholderImg}';">
                        </div>
                        
                        <div class="ml-4 flex-grow flex flex-col justify-center min-w-0">
                            <button class="sku-button" data-sku="${p.sku}">
                                <h3 class="text-lg font-bold text-brand-orange truncate">${p.sku}</h3>
                            </button>
                            <p class="text-sm font-medium text-gray-900 truncate">${p.brand}</p>
                            <p class="text-base font-semibold text-gray-800 mt-1">Amazon: ${p.amazonQty}</p>
                            <p class="text-base font-semibold text-gray-800">Temu: ${p.temuQty}</p>
                        </div>
                    </div>
                `);
            });
            
            bestsellersTableBody.innerHTML = tableRowsHtml.join('');
            bestsellersCardsContainer.innerHTML = cardsHtml.join('');
        }

        function handleTableClick(event) {
            const button = event.target.closest('.sku-button');
            if (button) {
                const sku = button.dataset.sku;
                openProductModal(sku);
            }
        }

        function openProductModal(sku) {
            const product = allProducts.find(p => p.sku === sku);
            if (!product) return;

            const placeholderImg = `https://placehold.co/150x150/FD991F/white?text=${product.sku[0] || '?'}`;
            
            modalImg.src = product.immagine || placeholderImg;
            modalImg.onerror = () => { modalImg.src = placeholderImg; };
            modalSku.textContent = product.sku;
            modalDetails.textContent = `Brand: ${product.brand || 'N/D'} | Categoria: ${product.categoria || 'N/D'}`;
            
            if (product.amazonQty > 0 || product.temuQty > 0) {
                 modalStock.textContent = `Vendite Amazon: ${product.amazonQty} | Vendite Temu: ${product.temuQty}`;
            } else {
                 modalStock.textContent = `Quantità in Magazzino: ${product.qty} | Scaffale: ${product.scaffale || 'N/D'}`;
            }

            geminiResultContainer.innerHTML = 'Clicca il pulsante per generare una descrizione...';
            geminiGenerateBtn.disabled = false;
            geminiGenerateBtn.textContent = '✨ Genera Descrizione Prodotto';
            geminiGenerateBtn.onclick = () => callGeminiForProduct(product);

            productModal.classList.remove('hidden');
        }

        function closeProductModal() {
            productModal.classList.add('hidden');
        }

        async function callGeminiForProduct(product) {
            geminiGenerateBtn.disabled = true;
            geminiResultContainer.innerHTML = `<div class="flex justify-center items-center"><span class="loader"></span></div>`;

            const systemPrompt = "Sei un esperto di marketing e-commerce. Il tuo compito è scrivere descrizioni di prodotto accattivanti, brevi (massimo 3 frasi) e focalizzate sui benefici per il cliente. Usa un tono entusiasta ma professionale. Rispondi solo con la descrizione generata.";
            const userQuery = `Genera una descrizione per questo prodotto:\n- Brand: ${product.brand}\n- Categoria: ${product.categoria}\n- SKU: ${product.sku}`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Errore API: ${response.statusText}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    geminiResultContainer.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>`;
                } else {
                    throw new Error("Nessun testo generato.");
                }

            } catch (error) {
                console.error('Errore chiamata Gemini:', error);
                geminiResultContainer.innerHTML = `<p class="text-red-600">Errore: Impossibile generare la descrizione. Riprova.</p>`;
                geminiGenerateBtn.disabled = false;
            }
        }

        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok && retries > 0) {
                    if (response.status >= 500 && response.status <= 599) {
                        throw new Error(`Errore server (ritento...): ${response.status}`);
                    } else {
                        return response; 
                    }
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                } else {
                    throw error;
                }
            }
        }
    </script>

</body>
</html>
