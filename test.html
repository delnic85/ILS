<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scannerizza Etichetta - I LOVE SHOPPING</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --brand-orange: #FD991F; --brand-gray: #7A8686; }
        body { font-family: 'Inter', sans-serif; }
        .loader {
            width: 48px; height: 48px; border: 5px solid #FFF; 
            border-bottom-color: var(--brand-orange); border-radius: 50%; 
            display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    
    <script>
        tailwind.config = {
            theme: { extend: { colors: { 'brand-orange': 'var(--brand-orange)', 'brand-gray': 'var(--brand-gray)' } } }
        }
    </script>
</head>
<body class="bg-gray-100 text-brand-gray min-h-screen antialiased overflow-x-hidden relative">

    <div id="perf-timer" class="fixed top-2 left-2 bg-black text-white px-3 py-1 rounded text-xs font-mono shadow-md z-50 hidden">Tempo: -- ms</div>

    <div class="container mx-auto w-full p-2 md:p-4"> 

        <header class="relative flex items-center justify-center mb-8">
            <h1 class="text-3xl md:text-5xl font-bold text-brand-orange tracking-tight">Scannerizza Etichetta</h1>
            <a href="https://delnic85.github.io/ILS/magazzino.html" class="absolute right-0 top-1/2 -translate-y-1/2 flex items-center gap-1 text-brand-gray hover:text-brand-orange font-semibold transition-colors duration-200 group">
                <span>Magazzino</span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 group-hover:translate-x-1 transition-transform"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" /></svg>
            </a>
        </header>

        <div class="bg-white rounded-2xl shadow-lg p-4 mb-6">
            <label for="search-box" class="sr-only">Cerca Tracking</label>
            <input type="text" id="search-box" placeholder="Inserisci il codice di tracking..." class="w-full p-4 border border-gray-300 rounded-lg text-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-brand-orange focus:border-transparent">
        </div>

        <div class="space-y-6">
            <div id="status-message" class="p-8 text-center bg-white rounded-2xl shadow-lg">
                <div class="flex flex-col items-center justify-center space-y-4">
                    <span class="loader"></span>
                    <span class="text-gray-500 font-medium" id="loading-text">Caricamento dati...</span>
                </div>
            </div>

            <div id="main-layout" class="flex flex-col lg:flex-row gap-6 hidden">
                <div id="orders-container" class="flex-1"></div>
                <div id="sidebar-container" class="w-full lg:w-1/4 hidden">
                    <div class="bg-white rounded-2xl shadow-lg overflow-hidden sticky top-4">
                        <div class="bg-brand-gray text-white p-3">
                            <h3 class="font-bold text-center uppercase tracking-wider text-sm">Totali in questo Report</h3>
                        </div>
                        <div class="p-4">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b border-gray-200">
                                        <th class="text-left py-2 text-brand-orange">SKU</th>
                                        <th class="text-right py-2 text-brand-gray">Venduti</th>
                                    </tr>
                                </thead>
                                <tbody id="sidebar-tbody"></tbody>
                            </table>
                            <p class="text-xs text-gray-400 mt-4 text-center italic">*Somma totale per questi SKU nel report corrente.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_ID_ORDINI = "1Qjj9QhNw4unnUV3t2kNP9j3K-usHzw-MCQ3laUrwqos";
        
        const NOMI_SCHEDE = [
            "GERMANIA", "FRANCIA", "ITALIA", "PAESI BASSI", "SPAGNA", 
            "BELGIO", "AUSTRIA", "REP. CECA", "UNGHERIA", "PORTOGALLO", 
            "DANIMARCA", "POLONIA", "AMAZON"
        ];

        const ORDER_SHEET_URLS = NOMI_SCHEDE.map(nome => 
            `https://docs.google.com/spreadsheets/d/${SHEET_ID_ORDINI}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(nome)}`
        );

        const SYNC_PRODOTTI_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQLf2HBC2g4q3L-hER7WPpYixWIIqJyV6MAkWm4ENZlQNrLxbroZRP3HBZ7Uzl510OVON8q590_YH_S/pub?gid=940187269&single=true&output=csv';
        const INVENTORY_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQLf2HBC2g4q3L-hER7WPpYixWIIqJyV6MAkWm4ENZlQNrLxbroZRP3HBZ7Uzl510OVON8q590_YH_S/pub?gid=938359466&single=true&output=csv';

        // --- MAPPATURA AMAZON (FISSA) ---
        const MAP_AMAZON = {
            ORDER_ID: 11,   // Colonna L
            TRACKING: 12,   // Colonna M
            SKU: 14,        // Colonna O
            ITEM_TITLE: 15, // Colonna P
            QTY: 17,        // Colonna R
            CLIENT: 1       // Colonna B
        };

        const SYNC_COLS = { ASIN: 0, SKU: 1 };
        const INVENTORY_COLS = { ASIN: 0, F_BRAND: 5, I_SCAFFALE: 8, AB_IMG_URL: 27 };

        let searchBox, statusMessage, loadingText, ordersContainer, perfTimer, sidebarContainer, sidebarTbody, mainLayout;
        let allGroupedOrders = [];
        let inventoryDataMap = new Map();
        let skuToAsinMap = new Map();
        let trackingIndex = new Map();
        let skuCountsByReport = [];
        let searchStartTime = 0;

        document.addEventListener('DOMContentLoaded', () => {
            searchBox = document.getElementById('search-box');
            statusMessage = document.getElementById('status-message');
            loadingText = document.getElementById('loading-text');
            ordersContainer = document.getElementById('orders-container');
            perfTimer = document.getElementById('perf-timer');
            sidebarContainer = document.getElementById('sidebar-container');
            sidebarTbody = document.getElementById('sidebar-tbody');
            mainLayout = document.getElementById('main-layout');

            searchBox.addEventListener('input', () => { renderOrders(); });
            searchBox.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.keyCode === 13) {
                    event.preventDefault(); 
                    searchStartTime = performance.now(); 
                    searchBox.select(); 
                    renderOrders();
                }
            });
            loadAllData();
        });

        function normalizeTracking(code) {
            if (!code) return "";
            return code.toString().replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
        }

        async function loadAllData() {
            try {
                const syncResponse = await fetch(SYNC_PRODOTTI_URL);
                if (syncResponse.ok) createSkuToAsinMap(await syncResponse.text());

                const invResponse = await fetch(INVENTORY_CSV_URL);
                if (invResponse.ok) createInventoryMap(await invResponse.text());

                const allOrdersMap = new Map();
                let ordersLoadedCount = 0;
                skuCountsByReport = new Array(NOMI_SCHEDE.length).fill(null);

                for (let i = 0; i < NOMI_SCHEDE.length; i++) {
                    const nome = NOMI_SCHEDE[i];
                    loadingText.textContent = `Caricamento ${nome}... (${i+1}/${NOMI_SCHEDE.length})`;
                    try {
                        const response = await fetch(ORDER_SHEET_URLS[i]);
                        if (response.ok) {
                            skuCountsByReport[i] = {}; 
                            processOrdersCsv(await response.text(), allOrdersMap, i);
                            ordersLoadedCount++;
                        }
                    } catch (e) { console.warn(`Errore scheda ${nome}`); }
                }

                if (ordersLoadedCount === 0) throw new Error('Nessun dato caricato.');

                allGroupedOrders = Array.from(allOrdersMap.values());
                buildTrackingIndex();
                renderOrders();
                statusMessage.classList.add('hidden');
            } catch (error) {
                console.error(error);
                statusMessage.innerHTML = `<div class="text-red-600 p-4">Errore: ${error.message}</div>`;
            }
        }

        function createSkuToAsinMap(csvText) {
            const lines = csvText.trim().split('\n'); lines.shift(); 
            lines.forEach(line => {
                const cols = parseCSVLine(line);
                if (cols[0] && cols[1]) skuToAsinMap.set(cols[1].trim(), cols[0].trim());
            });
        }

        function createInventoryMap(csvText) {
            const lines = csvText.trim().split('\n'); lines.shift();
            lines.forEach(line => {
                const cols = parseCSVLine(line);
                if (cols[0]) inventoryDataMap.set(cols[0].trim(), { 
                    imageUrl: cols[27] || '', scaffale: cols[8] || 'N/D', brand: cols[5] || 'N/D' 
                });
            });
        }

        function buildTrackingIndex() {
            trackingIndex.clear();
            allGroupedOrders.forEach(order => {
                if (order.tracking) trackingIndex.set(normalizeTracking(order.tracking), order);
            });
        }

        // --- FUNZIONE DI PROCESSAMENTO POTENZIATA (WIDE SEARCH) ---
        function processOrdersCsv(csvText, ordersMap, reportIndex) {
            const lines = csvText.trim().split('\n');
            lines.shift(); 
            let currentReportCounts = skuCountsByReport[reportIndex];
            
            const isAmazon = NOMI_SCHEDE[reportIndex] === "AMAZON";

            lines.forEach(line => {
                const cols = parseCSVLine(line);
                let orderId, sku, qty, cliente, tracking, itemTitle;

                if (isAmazon) {
                    if (cols.length <= 17) return; 
                    orderId = cols[MAP_AMAZON.ORDER_ID];
                    sku = cols[MAP_AMAZON.SKU] ? cols[MAP_AMAZON.SKU].trim() : 'N/D';
                    qty = parseInt(cols[MAP_AMAZON.QTY]) || 0;
                    cliente = cols[MAP_AMAZON.CLIENT] || 'N/D';
                    tracking = cols[MAP_AMAZON.TRACKING] ? cols[MAP_AMAZON.TRACKING].trim() : 'N/D';
                    itemTitle = cols[MAP_AMAZON.ITEM_TITLE] || 'N/D';
                } else {
                    // --- LOGICA TEMU "WIDE SEARCH" (RICERCA AMPIA) ---
                    if (cols.length < 15) return;

                    // 1. Tracking: Cerca da colonna 30 a 40 (copre quasi tutto)
                    tracking = null;
                    // Genera array [30, 31, ..., 40]
                    const trackingCandidates = Array.from({length: 11}, (_, i) => i + 30); 
                    for (let idx of trackingCandidates) {
                        let val = cols[idx] ? cols[idx].trim() : "";
                        // Logica: >5 char, no €, no punti decimali, sembra un tracking
                        if (val.length > 5 && !val.includes("€") && !val.includes(".")) {
                            tracking = val; break;
                        }
                    }

                    // 2. SKU: Cerca da colonna 5 a 15
                    sku = 'N/D';
                    const skuCandidates = Array.from({length: 11}, (_, i) => i + 5); 
                    for (let idx of skuCandidates) {
                        let val = cols[idx] ? cols[idx].trim() : "";
                        // Logica: >2 char, contiene trattino o GLS, o non è un numero puro
                        if (val.length > 2 && (val.includes("-") || val.includes("GLS") || isNaN(val))) {
                             // Escludi ID numerici lunghi e intestazioni
                             if (!/^\d{8,}$/.test(val) && val.length < 50) { 
                                 sku = val; break; 
                             }
                        }
                    }

                    // 3. Qty: Cerca da colonna 10 a 20
                    qty = 0;
                    const qtyCandidates = Array.from({length: 11}, (_, i) => i + 10);
                    for (let idx of qtyCandidates) {
                        let val = cols[idx] ? cols[idx].trim() : "";
                        // Logica: numero piccolo (<4 cifre)
                        if (val && !isNaN(val) && val.length < 4) {
                            qty = parseInt(val); break;
                        }
                    }

                    // 4. Cliente: Cerca da colonna 12 a 18
                    cliente = 'N/D';
                    const clientCandidates = Array.from({length: 7}, (_, i) => i + 12);
                    for (let idx of clientCandidates) {
                        let val = cols[idx] ? cols[idx].trim() : "";
                        // Logica: stringa testo, non numerica, lunghezza decente
                        if (val && val.length > 2 && isNaN(val) && !val.includes("€")) {
                            cliente = val; break;
                        }
                    }

                    orderId = cols[0]; // L'ID ordine è quasi sempre la prima colonna (A)
                    itemTitle = cols[7] || 'N/D'; // Titolo di solito in H
                }

                if (!orderId) return;

                if (sku !== 'N/D') {
                    if (!currentReportCounts[sku]) currentReportCounts[sku] = 0;
                    currentReportCounts[sku] += qty;
                }

                const asin = skuToAsinMap.get(sku);
                let inv = { imageUrl: '', scaffale: 'N/D', brand: 'N/D' };
                if (asin && inventoryDataMap.has(asin)) {
                    inv = inventoryDataMap.get(asin);
                }

                const item = {
                    articolo: itemTitle,
                    sku: sku,
                    asin: asin || 'N/D',
                    qty: qty,
                    imageUrl: inv.imageUrl,
                    scaffale: inv.scaffale,
                    brand: inv.brand
                };

                if (ordersMap.has(orderId)) {
                    ordersMap.get(orderId).items.push(item);
                } else {
                    ordersMap.set(orderId, {
                        orderId: orderId,
                        cliente: cliente,
                        tracking: tracking || 'N/D',
                        reportIndex: reportIndex,
                        items: [item]
                    });
                }
            });
